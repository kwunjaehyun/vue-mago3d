define(["./when-54335d57","./Cartesian2-8646c5a1","./ArcType-2b58731c","./GeometryOffsetAttribute-718fa138","./BoundingRectangle-07202124","./Transforms-79117a7b","./Check-24483042","./ComponentDatatype-1a100acd","./EllipsoidGeodesic-cc216670","./EllipsoidTangentPlane-325a8e68","./GeometryAttribute-374f805d","./GeometryInstance-6aa9010a","./GeometryPipeline-571ff4c9","./IndexDatatype-82ceea78","./Math-d6182036","./PolygonGeometryLibrary-2a7648d9","./PolygonPipeline-97a7160d","./VertexFormat-81ec7207","./RuntimeError-88a32665","./WebGLConstants-95ceb4e9","./IntersectionTests-5394f658","./Plane-13ae4b1b","./AttributeCompression-10c27d9c","./EncodedCartesian3-bf827957","./arrayRemoveDuplicates-3fea1e5f","./EllipsoidRhumbLine-2b7999f3","./GeometryAttributes-caa08d6c"],function(Y,U,c,j,e,Q,t,q,y,D,K,L,N,H,Z,R,M,b,r,a,o,i,n,s,l,u,p){"use strict";var m=new U.Cartographic,g=new U.Cartographic;function J(e,t,r,a){var o=a.cartesianToCartographic(e,m).height,i=a.cartesianToCartographic(t,g);i.height=o,a.cartographicToCartesian(i,t);var n=a.cartesianToCartographic(r,g);n.height=o-100,a.cartographicToCartesian(n,r)}var S=new e.BoundingRectangle,X=new U.Cartesian3,$=new U.Cartesian3,ee=new U.Cartesian3,te=new U.Cartesian3,re=new U.Cartesian3,ae=new U.Cartesian3,oe=new U.Cartesian3,ie=new U.Cartesian3,ne=new U.Cartesian3,se=new U.Cartesian2,le=new U.Cartesian2,ue=new U.Cartesian3,pe=new Q.Quaternion,ce=new Q.Matrix3,ye=new Q.Matrix3;function B(e){var t,r,a,o=e.vertexFormat,i=e.geometry,n=e.shadowVolume,s=i.attributes.position.values,l=s.length,u=e.wall,p=e.top||u,c=e.bottom||u;if(o.st||o.normal||o.tangent||o.bitangent||n){var y=e.boundingRectangle,m=e.tangentPlane,g=e.ellipsoid,d=e.stRotation,h=e.perPositionHeight,f=se;f.x=y.x,f.y=y.y;var b,v=o.st?new Float32Array(l/3*2):void 0;o.normal&&(b=h&&p&&!u?i.attributes.normal.values:new Float32Array(l));var _,P=o.tangent?new Float32Array(l):void 0,C=o.bitangent?new Float32Array(l):void 0,w=n?new Float32Array(l):void 0,x=0,T=0,I=$,A=ee,E=te,G=!0,O=ce,V=ye;V=0!==d?(_=Q.Quaternion.fromAxisAngle(m._plane.normal,d,pe),O=Q.Matrix3.fromQuaternion(_,O),_=Q.Quaternion.fromAxisAngle(m._plane.normal,-d,pe),Q.Matrix3.fromQuaternion(_,V)):(O=Q.Matrix3.clone(Q.Matrix3.IDENTITY,O),Q.Matrix3.clone(Q.Matrix3.IDENTITY,V));var F=0,D=0;p&&c&&(F=l/2,D=l/3,l/=2);for(var L=0;L<l;L+=3){var N,H,R,M,S,B,k,z,W=U.Cartesian3.fromArray(s,L,ue);o.st&&(N=Q.Matrix3.multiplyByVector(O,W,X),N=g.scaleToGeodeticSurface(N,N),H=m.projectPointOntoPlane(N,le),U.Cartesian2.subtract(H,f,H),R=Z.CesiumMath.clamp(H.x/y.width,0,1),M=Z.CesiumMath.clamp(H.y/y.height,0,1),c&&(v[x+D]=R,v[x+1+D]=M),p&&(v[x]=R,v[x+1]=M),x+=2),(o.normal||o.tangent||o.bitangent||n)&&(S=T+1,B=T+2,u?(L+3<l&&(k=U.Cartesian3.fromArray(s,L+3,re),G&&(z=U.Cartesian3.fromArray(s,L+l,ae),h&&J(W,k,z,g),U.Cartesian3.subtract(k,W,k),U.Cartesian3.subtract(z,W,z),I=U.Cartesian3.normalize(U.Cartesian3.cross(z,k,I),I),G=!1),U.Cartesian3.equalsEpsilon(k,W,Z.CesiumMath.EPSILON10)&&(G=!0)),(o.tangent||o.bitangent)&&(E=g.geodeticSurfaceNormal(W,E),o.tangent&&(A=U.Cartesian3.normalize(U.Cartesian3.cross(E,I,A),A)))):(I=g.geodeticSurfaceNormal(W,I),(o.tangent||o.bitangent)&&(h&&(oe=U.Cartesian3.fromArray(b,T,oe),ie=U.Cartesian3.cross(U.Cartesian3.UNIT_Z,oe,ie),ie=U.Cartesian3.normalize(Q.Matrix3.multiplyByVector(V,ie,ie),ie),o.bitangent&&(ne=U.Cartesian3.normalize(U.Cartesian3.cross(oe,ie,ne),ne))),A=U.Cartesian3.cross(U.Cartesian3.UNIT_Z,I,A),A=U.Cartesian3.normalize(Q.Matrix3.multiplyByVector(V,A,A),A),o.bitangent&&(E=U.Cartesian3.normalize(U.Cartesian3.cross(I,A,E),E)))),o.normal&&(e.wall?(b[T+F]=I.x,b[S+F]=I.y,b[B+F]=I.z):c&&(b[T+F]=-I.x,b[S+F]=-I.y,b[B+F]=-I.z),(p&&!h||u)&&(b[T]=I.x,b[S]=I.y,b[B]=I.z)),n&&(u&&(I=g.geodeticSurfaceNormal(W,I)),w[T+F]=-I.x,w[S+F]=-I.y,w[B+F]=-I.z),o.tangent&&(e.wall?(P[T+F]=A.x,P[S+F]=A.y,P[B+F]=A.z):c&&(P[T+F]=-A.x,P[S+F]=-A.y,P[B+F]=-A.z),p&&(h?(P[T]=ie.x,P[S]=ie.y,P[B]=ie.z):(P[T]=A.x,P[S]=A.y,P[B]=A.z))),o.bitangent&&(c&&(C[T+F]=E.x,C[S+F]=E.y,C[B+F]=E.z),p&&(h?(C[T]=ne.x,C[S]=ne.y,C[B]=ne.z):(C[T]=E.x,C[S]=E.y,C[B]=E.z))),T+=3)}o.st&&(i.attributes.st=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:v})),o.normal&&(i.attributes.normal=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:b})),o.tangent&&(i.attributes.tangent=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:P})),o.bitangent&&(i.attributes.bitangent=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:C})),n&&(i.attributes.extrudeDirection=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:w}))}return e.extrude&&Y.defined(e.offsetAttribute)&&(t=s.length/3,a=new Uint8Array(t),e.offsetAttribute===j.GeometryOffsetAttribute.TOP?p&&c||u?a=j.arrayFill(a,1,0,t/2):p&&(a=j.arrayFill(a,1)):(r=e.offsetAttribute===j.GeometryOffsetAttribute.NONE?0:1,a=j.arrayFill(a,r)),i.attributes.applyOffset=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:a})),i}var d=new U.Cartographic,h=new U.Cartographic,f={westOverIDL:0,eastOverIDL:0},v=new y.EllipsoidGeodesic;function _(e,t,r,a,o){if(o=Y.defaultValue(o,new U.Rectangle),!Y.defined(e)||e.length<3)return o.west=0,o.north=0,o.south=0,o.east=0,o;if(r===c.ArcType.RHUMB)return U.Rectangle.fromCartesianArray(e,t,o);v.ellipsoid.equals(t)||(v=new y.EllipsoidGeodesic(void 0,void 0,t)),o.west=Number.POSITIVE_INFINITY,o.east=Number.NEGATIVE_INFINITY,o.south=Number.POSITIVE_INFINITY,o.north=Number.NEGATIVE_INFINITY,f.westOverIDL=Number.POSITIVE_INFINITY,f.eastOverIDL=Number.NEGATIVE_INFINITY;for(var i,n=1/Z.CesiumMath.chordLength(a,t.maximumRadius),s=e.length,l=t.cartesianToCartographic(e[0],h),u=d,p=1;p<s;p++)i=u,u=l,l=t.cartesianToCartographic(e[p],i),v.setEndPoints(u,l),C(v,n,o,f);return i=u,u=l,l=t.cartesianToCartographic(e[0],i),v.setEndPoints(u,l),C(v,n,o,f),o.east-o.west>f.eastOverIDL-f.westOverIDL&&(o.west=f.westOverIDL,o.east=f.eastOverIDL,o.east>Z.CesiumMath.PI&&(o.east=o.east-Z.CesiumMath.TWO_PI),o.west>Z.CesiumMath.PI&&(o.west=o.west-Z.CesiumMath.TWO_PI)),o}var P=new U.Cartographic;function C(e,t,r,a){for(var o=e.surfaceDistance,i=Math.ceil(o*t),n=0<i?o/(i-1):Number.POSITIVE_INFINITY,s=0,l=0;l<i;l++){var u=e.interpolateUsingSurfaceDistance(s,P);s+=n;var p=u.longitude,c=u.latitude;r.west=Math.min(r.west,p),r.east=Math.max(r.east,p),r.south=Math.min(r.south,c),r.north=Math.max(r.north,c);var y=0<=p?p:p+Z.CesiumMath.TWO_PI;a.westOverIDL=Math.min(a.westOverIDL,y),a.eastOverIDL=Math.max(a.eastOverIDL,y)}}var E=[];function k(e,t,r,a,o,i,n,s,l){var u={walls:[]};if(i||n){var p=R.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,o,s,l),c=p.attributes.position.values,y=p.indices;if(i&&n){var m,g=c.concat(c),d=g.length/3;(m=H.IndexDatatype.createTypedArray(d,2*y.length)).set(y);for(var h,f=y.length,b=d/2,v=0;v<f;v+=3){var _=m[v]+b,P=m[v+1]+b,C=m[v+2]+b;m[v+f]=C,m[v+1+f]=P,m[v+2+f]=_}p.attributes.position.values=g,o&&s.normal&&(h=p.attributes.normal.values,p.attributes.normal.values=new Float32Array(g.length),p.attributes.normal.values.set(h)),p.indices=m}else if(n){for(d=c.length/3,m=H.IndexDatatype.createTypedArray(d,y.length),v=0;v<y.length;v+=3)m[v]=y[v+2],m[v+1]=y[v+1],m[v+2]=y[v];p.indices=m}u.topAndBottom=new L.GeometryInstance({geometry:p})}var w=a.outerRing,x=D.EllipsoidTangentPlane.fromPoints(w,e).projectPointsOntoPlane(w,E);M.PolygonPipeline.computeWindingOrder2D(x)===M.WindingOrder.CLOCKWISE&&(w=w.slice().reverse());var T=R.PolygonGeometryLibrary.computeWallGeometry(w,e,r,o,l);u.walls.push(new L.GeometryInstance({geometry:T}));var I=a.holes;for(v=0;v<I.length;v++){var A=I[v],x=D.EllipsoidTangentPlane.fromPoints(A,e).projectPointsOntoPlane(A,E);M.PolygonPipeline.computeWindingOrder2D(x)===M.WindingOrder.COUNTER_CLOCKWISE&&(A=A.slice().reverse()),T=R.PolygonGeometryLibrary.computeWallGeometry(A,e,r,o,l),u.walls.push(new L.GeometryInstance({geometry:T}))}return u}function w(e){var t,r=e.polygonHierarchy,a=Y.defaultValue(e.vertexFormat,b.VertexFormat.DEFAULT),o=Y.defaultValue(e.ellipsoid,U.Ellipsoid.WGS84),i=Y.defaultValue(e.granularity,Z.CesiumMath.RADIANS_PER_DEGREE),n=Y.defaultValue(e.stRotation,0),s=Y.defaultValue(e.perPositionHeight,!1),l=s&&Y.defined(e.extrudedHeight),u=Y.defaultValue(e.height,0),p=Y.defaultValue(e.extrudedHeight,u);l||(t=Math.max(u,p),p=Math.min(u,p),u=t),this._vertexFormat=b.VertexFormat.clone(a),this._ellipsoid=U.Ellipsoid.clone(o),this._granularity=i,this._stRotation=n,this._height=u,this._extrudedHeight=p,this._closeTop=Y.defaultValue(e.closeTop,!0),this._closeBottom=Y.defaultValue(e.closeBottom,!0),this._polygonHierarchy=r,this._perPositionHeight=s,this._perPositionHeightExtrude=l,this._shadowVolume=Y.defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=Y.defaultValue(e.arcType,c.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=R.PolygonGeometryLibrary.computeHierarchyPackedLength(r)+U.Ellipsoid.packedLength+b.VertexFormat.packedLength+12}w.fromPositions=function(e){return new w({polygonHierarchy:{positions:(e=Y.defaultValue(e,Y.defaultValue.EMPTY_OBJECT)).positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},w.pack=function(e,t,r){return r=Y.defaultValue(r,0),r=R.PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,t,r),U.Ellipsoid.pack(e._ellipsoid,t,r),r+=U.Ellipsoid.packedLength,b.VertexFormat.pack(e._vertexFormat,t,r),r+=b.VertexFormat.packedLength,t[r++]=e._height,t[r++]=e._extrudedHeight,t[r++]=e._granularity,t[r++]=e._stRotation,t[r++]=e._perPositionHeightExtrude?1:0,t[r++]=e._perPositionHeight?1:0,t[r++]=e._closeTop?1:0,t[r++]=e._closeBottom?1:0,t[r++]=e._shadowVolume?1:0,t[r++]=Y.defaultValue(e._offsetAttribute,-1),t[r++]=e._arcType,t[r]=e.packedLength,t};var x=U.Ellipsoid.clone(U.Ellipsoid.UNIT_SPHERE),T=new b.VertexFormat,I={polygonHierarchy:{}};return w.unpack=function(e,t,r){t=Y.defaultValue(t,0);var a=R.PolygonGeometryLibrary.unpackPolygonHierarchy(e,t);t=a.startingIndex,delete a.startingIndex;var o=U.Ellipsoid.unpack(e,t,x);t+=U.Ellipsoid.packedLength;var i=b.VertexFormat.unpack(e,t,T);t+=b.VertexFormat.packedLength;var n=e[t++],s=e[t++],l=e[t++],u=e[t++],p=1===e[t++],c=1===e[t++],y=1===e[t++],m=1===e[t++],g=1===e[t++],d=e[t++],h=e[t++],f=e[t];return Y.defined(r)||(r=new w(I)),r._polygonHierarchy=a,r._ellipsoid=U.Ellipsoid.clone(o,r._ellipsoid),r._vertexFormat=b.VertexFormat.clone(i,r._vertexFormat),r._height=n,r._extrudedHeight=s,r._granularity=l,r._stRotation=u,r._perPositionHeightExtrude=p,r._perPositionHeight=c,r._closeTop=y,r._closeBottom=m,r._shadowVolume=g,r._offsetAttribute=-1===d?void 0:d,r._arcType=h,r.packedLength=f,r},w.computeRectangle=function(e,t){var r=Y.defaultValue(e.granularity,Z.CesiumMath.RADIANS_PER_DEGREE),a=Y.defaultValue(e.arcType,c.ArcType.GEODESIC),o=e.polygonHierarchy,i=Y.defaultValue(e.ellipsoid,U.Ellipsoid.WGS84);return _(o.positions,i,a,r,t)},w.createGeometry=function(e){var t=e._vertexFormat,r=e._ellipsoid,a=e._granularity,o=e._stRotation,i=e._polygonHierarchy,n=e._perPositionHeight,s=e._closeTop,l=e._closeBottom,u=e._arcType,p=i.positions;if(!(p.length<3)){var c=D.EllipsoidTangentPlane.fromPoints(p,r),y=R.PolygonGeometryLibrary.polygonsFromHierarchy(i,c.projectPointsOntoPlane.bind(c),!n,r),m=y.hierarchy,g=y.polygons;if(0!==m.length){p=m[0].outerRing;var d,h=R.PolygonGeometryLibrary.computeBoundingRectangle(c.plane.normal,c.projectPointOntoPlane.bind(c),p,o,S),f=[],b=e._height,v=e._extrudedHeight,_={perPositionHeight:n,vertexFormat:t,geometry:void 0,tangentPlane:c,boundingRectangle:h,ellipsoid:r,stRotation:o,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:u};if(e._perPositionHeightExtrude||!Z.CesiumMath.equalsEpsilon(b,v,0,Z.CesiumMath.EPSILON2))for(_.extrude=!0,_.top=s,_.bottom=l,_.shadowVolume=e._shadowVolume,_.offsetAttribute=e._offsetAttribute,d=0;d<g.length;d++){var P,C=k(r,g[d],a,m[d],n,s,l,t,u);s&&l?(P=C.topAndBottom,_.geometry=R.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(P.geometry,b,v,r,n)):s?((P=C.topAndBottom).geometry.attributes.position.values=M.PolygonPipeline.scaleToGeodeticHeight(P.geometry.attributes.position.values,b,r,!n),_.geometry=P.geometry):l&&((P=C.topAndBottom).geometry.attributes.position.values=M.PolygonPipeline.scaleToGeodeticHeight(P.geometry.attributes.position.values,v,r,!0),_.geometry=P.geometry),(s||l)&&(_.wall=!1,P.geometry=B(_),f.push(P));var w=C.walls;_.wall=!0;for(var x=0;x<w.length;x++){var T=w[x];_.geometry=R.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(T.geometry,b,v,r,n),T.geometry=B(_),f.push(T)}}else for(d=0;d<g.length;d++){var I,A,E,G=new L.GeometryInstance({geometry:R.PolygonGeometryLibrary.createGeometryFromPositions(r,g[d],a,n,t,u)});G.geometry.attributes.position.values=M.PolygonPipeline.scaleToGeodeticHeight(G.geometry.attributes.position.values,b,r,!n),_.geometry=G.geometry,G.geometry=B(_),Y.defined(e._offsetAttribute)&&(I=G.geometry.attributes.position.values.length,A=new Uint8Array(I/3),E=e._offsetAttribute===j.GeometryOffsetAttribute.NONE?0:1,j.arrayFill(A,E),G.geometry.attributes.applyOffset=new K.GeometryAttribute({componentDatatype:q.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:A})),f.push(G)}var O=N.GeometryPipeline.combineInstances(f)[0];O.attributes.position.values=new Float64Array(O.attributes.position.values),O.indices=H.IndexDatatype.createTypedArray(O.attributes.position.values.length/3,O.indices);var V=O.attributes,F=Q.BoundingSphere.fromVertices(V.position.values);return t.position||delete V.position,new K.Geometry({attributes:V,indices:O.indices,primitiveType:O.primitiveType,boundingSphere:F,offsetAttribute:e._offsetAttribute})}}},w.createShadowVolume=function(e,t,r){var a=e._granularity,o=e._ellipsoid,i=t(a,o),n=r(a,o);return new w({polygonHierarchy:e._polygonHierarchy,ellipsoid:o,stRotation:e._stRotation,granularity:a,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:b.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(w.prototype,{rectangle:{get:function(){var e;return Y.defined(this._rectangle)||(e=this._polygonHierarchy.positions,this._rectangle=_(e,this._ellipsoid,this._arcType,this._granularity)),this._rectangle}},textureCoordinateRotationPoints:{get:function(){return Y.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0==t)return[0,0,0,1,1,0];var r=e._ellipsoid,a=e._polygonHierarchy.positions,o=e.rectangle;return K.Geometry._textureCoordinateRotationPoints(a,t,r,o)}(this)),this._textureCoordinateRotationPoints}}}),function(e,t){return Y.defined(t)&&(e=w.unpack(e,t)),e._ellipsoid=U.Ellipsoid.clone(e._ellipsoid),w.createGeometry(e)}});
